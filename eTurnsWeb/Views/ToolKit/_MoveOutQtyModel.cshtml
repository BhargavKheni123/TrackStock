@model eTurns.DTO.KitDetailDTO
<div style="float: left; width: 99%">
    <div style="height: 40px; float: left; width: 99%; display: block">
        <div class="infoBlock">
            <ul>
                <li>
                    <label for="RoomName">@eTurns.DTO.ResItemMaster.ItemNumber</label>:<span> @Model.ItemDetail.ItemNumber</span>
                </li>
                <li style="border-right: 0px solid black;">
                    <label for="RoomName">@eTurns.DTO.ResItemMaster.OnHandQuantity</label>: <span id="spnOnHandQty">@Model.ItemDetail.OnHandQuantity</span>
                </li>
            </ul>
        </div>
    </div>
    <div style="height: 40px; float: left; width: 99%">
        <span>Location:</span>&nbsp; @Html.DropDownList("ddlLocation", (SelectList)ViewBag.DropDownData, new { style = "width:120px;",@class = "selectBox", })
        <span>Quantity:</span>&nbsp;
        <input type="text" id="txtQty" , class = "text-box" value="" onkeydown="return OnlyNumeric(event,this)"
            style="width: 50px;background:White;" />
        <input type="button" id="btnDelete" value="Delete" class="CreateBtn" style="margin: 0px 5px 0px 5px" />
        <input type="button" id="btnAdd" value="Add" class="CreateBtn" style="margin: 0px 5px 0px 5px" />
    </div>
    <div style="height: 200px; float: left; width: 99%; overflow: auto">
        <table class="display" id="ItemWithQtyList">
        </table>
    </div>
    <div style="height: 50px; float: left; width: 99%;">
        <input type="button" id="btnCancel" value="Cancel" class="CreateBtn" />
        <input type="button" id="btnMove" value="@((string)ViewBag.ButtonText)" class="CreateBtn" />
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        oTableKitItemLocation = $('#ItemWithQtyList').dataTable({
            "bPaginate": false,
            "bLengthChange": false,
            "bFilter": false,
            "bSort": false,
            "bInfo": false,
            "bAutoWidth": false,
            "aoColumns":
            [
                { "sTitle": "ID" },
                { "sTitle": "Location" },
                { "sTitle": "Quantity" },
            ]
        });


        fillGridFromSession();
        var ddlKitCatSelectedVal = parseInt($('#KitCategory').val());
        if (ddlKitCatSelectedVal != null && ddlKitCatSelectedVal == 1) {
            {
                if ('@((string)ViewBag.ButtonText)' == "Move In")
                    $('#btnMove').val('Add');
                else
                    $('#btnMove').val('Remove');
            }
        }

    });

    function fillGridFromSession() {
        $.ajax({
            url: '@Url.Content("~/Kit/GetItemWisePullUnSavedData")',
            data: { 'ItemID': '@Model.ItemGUID' },
            dataType: 'json',
            type: 'GET',
            async: false,
            cache: false,
            success: function (response) {
                if (response.Result != null) {
                    for (var i = 0; i <= response.Result.length - 1; i++) {
                        $('#ItemWithQtyList').dataTable().fnAddData([response.Result[i].BinID, response.Result[i].BinLocation, response.Result[i].TempPullQTY]);
                    }
                    var sum = 0;
                    $('#ItemWithQtyList tbody tr').each(function () {
                        if ($(this).find('td')[2] !== undefined && $(this).find('td').length > 1) {
                            sum = parseFloat(sum, 10) + parseFloat($(this).find('td')[2].innerHTML);
                        }
                    });

                    $('#ItemWithQtyList tfoot tr:first').remove();
                    if (sum > 0)
                        $('#ItemWithQtyList').append('<tfoot><tr><th></th><th style="text-align:right">Total</th><th id="fthSum" style="text-align:left">' + sum + '</th></tr>');

                }
            }
        });
    }

    $('#btnCancel').live('click', function () {
        $('.ui-dialog-titlebar-close').click();
    });

    $('#btnAdd').click(function () {

        if ('@ViewBag.ButtonText' == 'Move In') {

            if (parseFloat($('#txtQty').val()) > 0 && parseInt($('#ddlLocation').val()) > 0) {
                if (parseFloat($('#txtQty').val()) > 0 && parseInt($('#ddlLocation').val()) > 0) {
                    if (parseFloat($('#txtQty').val()) <= parseFloat($('#spnOnHandQty').text())) {
                        var sum = 0;
                        var found = 0;
                        $('#ItemWithQtyList tbody tr').each(function () {
                            if ($(this).find('td')[2] !== undefined && $(this).find('td').length > 1) {
                                sum = parseFloat(sum, 10) + parseFloat($(this).find('td')[2].innerHTML);
                            }
                            if ($(this).find('td')[0].innerHTML === $('#ddlLocation').val() && $(this).find('td').length > 1) {
                                found = 1;
                                var vals = parseFloat($(this).find('td')[2].innerHTML) + parseFloat($('#txtQty').val());
                                $(this).find('td')[2].innerHTML = vals;
                            }
                        });


                        sum = sum + parseFloat($('#txtQty').val());
                        if (found === 0) {
                            $('#ItemWithQtyList').dataTable().fnAddData([$('#ddlLocation').val(), $("#ddlLocation option:selected").text(), $('#txtQty').val()]);
                        }
                        $('#ItemWithQtyList tfoot tr:first').remove();
                        $('#ItemWithQtyList').append('<tfoot><tr><th></th><th style="text-align:right">Total</th><th id="fthSum" style="text-align:left">' + sum + '</th></tr>');

                        $('#spnOnHandQty').text(parseFloat($('#spnOnHandQty').text()) - parseFloat($('#txtQty').val()))
                        $('#txtQty').val('')
                    }
                }
            }
        }
        else {

            if (parseFloat($('#txtQty').val()) > 0 && parseInt($('#ddlLocation').val()) > 0) {
                if (parseFloat($('#txtQty').val()) > 0 && parseInt($('#ddlLocation').val()) > 0) {

                    var sum = 0;
                    var found = 0;
                    $('#ItemWithQtyList tbody tr').each(function () {
                        if ($(this).find('td')[2] !== undefined && $(this).find('td').length > 1) {
                            sum = parseFloat(sum, 10) + parseFloat($(this).find('td')[2].innerHTML);
                        }
                        if ($(this).find('td')[0].innerHTML === $('#ddlLocation').val() && $(this).find('td').length > 1) {
                            found = 1;
                            var vals = parseFloat($(this).find('td')[2].innerHTML) + parseFloat($('#txtQty').val());
                            $(this).find('td')[2].innerHTML = vals;
                        }
                    });


                    sum = sum + parseFloat($('#txtQty').val());
                    if (found === 0) {
                        $('#ItemWithQtyList').dataTable().fnAddData([$('#ddlLocation').val(), $("#ddlLocation option:selected").text(), $('#txtQty').val()]);
                    }
                    $('#ItemWithQtyList tfoot tr:first').remove();
                    $('#ItemWithQtyList').append('<tfoot><tr><th></th><th style="text-align:right">Total</th><th id="fthSum" style="text-align:left">' + sum + '</th></tr>');

                    $('#spnOnHandQty').text(parseFloat($('#spnOnHandQty').text()) + parseFloat($('#txtQty').val()))
                    $('#txtQty').val('')
                }

            }
        }
    });

    $("#ItemWithQtyList tbody").click(function (event) {
        $(oTableKitItemLocation.fnSettings().aoData).each(function () {
            $(this.nTr).removeClass('row_selected');
        });
        $(event.target.parentNode).addClass('row_selected');
    });

    $('#btnDelete').click(function () {
        var anSelectedMan = fnGetSelected(oTableKitItemLocation);
        if (anSelectedMan.length > 0 && $(anSelectedMan[0]).find('td').length > 1) {
            $('#spnOnHandQty').text(parseFloat($('#spnOnHandQty').text()) + parseFloat($(anSelectedMan[0]).find('td')[2].innerHTML));
            oTableKitItemLocation.fnDeleteRow(anSelectedMan[0]);
            var sum = 0;
            $('#ItemWithQtyList tbody tr').each(function () {
                if ($(this).find('td').length > 1)
                    sum = parseFloat(sum, 10) + parseFloat($(this).find('td')[2].innerHTML);
            });

            if ($(anSelectedMan[0]).find('td').length > 1) {
                $('#ItemWithQtyList tfoot tr:first').remove();
                $('#ItemWithQtyList').append('<tfoot><tr><th></th><th style="text-align:right">Total</th><th id="fthSum" style="text-align:left">' + sum + '</th></tr>');
            }
            else {
                $('#ItemWithQtyList tfoot tr:first').remove();
            }
        }
        else
            alert('@ResMessage.msgSelectRecordForDelete');
    });


    $('#btnMove').click(function () {

        var totolQty = $("#ItemWithQtyList tfoot tr").find('th')[2].innerHTML;
        var arrLocWiseQty = new Array();

        $('#ItemWithQtyList tbody tr').each(function () {
            if ($(this).find('td').length > 1) {
                var locationID = parseInt($(this).find('td')[0].innerHTML);
                var locationName = $(this).find('td')[1].innerHTML
                var Qty = parseFloat($(this).find('td')[2].innerHTML);
                arrLocWiseQty.push({ 'LocationID': locationID, 'LocationName': locationName, 'Quantity': Qty, 'KitDetailID': '@Model.ID' });
            }
            else
                return false;
        });
        var obj = { 'ItemID': '@Model.ItemGUID', 'LocationWiseQty': arrLocWiseQty, 'TotalQty': totolQty, 'ItemGUID': '@Model.ItemGUID', 'ButtonText': '@ViewBag.ButtonText' };

        $.ajax({
            url: 'AddItemQuantityInItemWIP',
            data: { 'para': JSON.stringify(obj) },
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.Status == "success") {
                    $('.ui-dialog-titlebar-close').click();
                }
            }
        });
    });

   
</script>
